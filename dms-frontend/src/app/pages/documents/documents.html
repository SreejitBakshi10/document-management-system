<h2>Documents</h2>

<div class="search-bar">

    <mat-form-field appearance="outline">
        <mat-label>Search</mat-label>
        <input matInput [(ngModel)]="search">
    </mat-form-field>

    <mat-form-field appearance="outline">
        <mat-label>Filter by Tags</mat-label>

        <mat-select multiple [(ngModel)]="selectedTags">

            <mat-option *ngFor="let tag of allTags" [value]="tag">

                {{ tag }}

            </mat-option>

        </mat-select>

    </mat-form-field>

    <button mat-raised-button color="primary" (click)="loadDocuments()">
        <mat-icon>search</mat-icon>
    </button>

    <button mat-stroked-button (click)="resetFilters()">
        Reset
    </button>

</div>

<div *ngIf="loading" class="loading">
    Loading...
</div>

<table mat-table [dataSource]="documents" class="mat-elevation-z8 full-width" *ngIf="!loading">

    <!-- Title -->
    <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef> Title </th>
        <td mat-cell *matCellDef="let doc"> {{ doc.title }} </td>
    </ng-container>

    <!-- Tags -->
    <ng-container matColumnDef="tags">
        <th mat-header-cell *matHeaderCellDef> Tags </th>
        <td mat-cell *matCellDef="let doc"> {{ doc.tags.join(', ') }} </td>
    </ng-container>

    <!-- Version -->
    <ng-container matColumnDef="version">
        <th mat-header-cell *matHeaderCellDef> Version </th>
        <td mat-cell *matCellDef="let doc"> {{ doc.currentVersion }} </td>
    </ng-container>

    <!-- Owner -->
    <ng-container matColumnDef="owner">
        <th mat-header-cell *matHeaderCellDef> Owner </th>
        <td mat-cell *matCellDef="let doc"> {{ doc.owner?.name }} </td>
    </ng-container>

    <!-- Created -->
    <ng-container matColumnDef="created">
        <th mat-header-cell *matHeaderCellDef> Created </th>
        <td mat-cell *matCellDef="let doc">
            {{ doc.createdAt | date:'short' }}
        </td>
    </ng-container>

    <!-- Download -->
    <ng-container matColumnDef="download">
        <th mat-header-cell *matHeaderCellDef> </th>
        <td mat-cell *matCellDef="let doc">
            <button mat-icon-button color="primary" (click)="downloadFile(doc)" matTooltip="Download">
                <mat-icon>download</mat-icon>
            </button>
        </td>
    </ng-container>

    <!-- Shared Info -->
    <ng-container matColumnDef="shared">
        <th mat-header-cell *matHeaderCellDef> Shared With </th>
        <td mat-cell *matCellDef="let doc">
            <span *ngIf="canSeeSharingInfo(doc)">
                <span *ngFor="let p of doc.permissions; let last = last" [matTooltip]="p.user.email">
                    {{ p.user.name }} ({{ p.access }})
                    <span *ngIf="!last">, </span>
                </span>
            </span>
            <span *ngIf="!canSeeSharingInfo(doc)">â€”</span>
        </td>
    </ng-container>

    <!-- Share -->
    <ng-container matColumnDef="share">
        <th mat-header-cell *matHeaderCellDef> </th>
        <td mat-cell *matCellDef="let doc">
            <div *ngIf="canShare(doc)" class="share-row">

                <mat-form-field appearance="outline">
                    <input matInput placeholder="Email" [(ngModel)]="shareEmail[doc._id]">
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Permission</mat-label>
                    <mat-select [(ngModel)]="shareAccess[doc._id]">
                        <mat-option value="view">View</mat-option>
                        <mat-option value="edit">Edit</mat-option>
                    </mat-select>
                </mat-form-field>

                <button mat-icon-button color="primary" (click)="share(doc)" matTooltip="Share">
                    <mat-icon>share</mat-icon>
                </button>

            </div>

            <span *ngIf="!canShare(doc)"></span>
        </td>
    </ng-container>

    <!-- Delete -->
    <ng-container matColumnDef="delete">
        <th mat-header-cell *matHeaderCellDef> </th>
        <td mat-cell *matCellDef="let doc">
            <button mat-icon-button color="warn" *ngIf="isOwner(doc)" (click)="openDeleteDialog(doc)"
                matTooltip="Delete">
                <mat-icon>delete</mat-icon>
            </button>
            <span *ngIf="!isOwner(doc)"></span>
        </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

</table>

<div *ngIf="!loading && documents.length === 0" class="empty-state">
    No documents found.
</div>

<div *ngIf="loading" class="loading">
    <mat-spinner diameter="40"></mat-spinner>
</div>